import { Request, Response } from 'express';
import { AbiItem } from 'web3-utils';
import { erc1155Mint } from '../types';
import erc_1155_abi from '../utils/abi/erc1155';
import { erc_1155 } from '../utils/contracts';
import getProvider from '../utils/getProvider';

const testErc1155Bytecode =
  '608060405234801562000010575f80fd5b506040518060400160405280600381526020017f757269000000000000000000000000000000000000000000000000000000000081525062000058816200005f60201b60201c565b50620003bc565b8060029081620000709190620002d8565b5050565b5f81519050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f6002820490506001821680620000f057607f821691505b602082108103620001065762000105620000ab565b5b50919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f600883026200016a7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826200012d565b6200017686836200012d565b95508019841693508086168417925050509392505050565b5f819050919050565b5f819050919050565b5f620001c0620001ba620001b4846200018e565b62000197565b6200018e565b9050919050565b5f819050919050565b620001db83620001a0565b620001f3620001ea82620001c7565b84845462000139565b825550505050565b5f90565b62000209620001fb565b62000216818484620001d0565b505050565b5b818110156200023d57620002315f82620001ff565b6001810190506200021c565b5050565b601f8211156200028c5762000256816200010c565b62000261846200011e565b8101602085101562000271578190505b6200028962000280856200011e565b8301826200021b565b50505b505050565b5f82821c905092915050565b5f620002ae5f198460080262000291565b1980831691505092915050565b5f620002c883836200029d565b9150826002028217905092915050565b620002e38262000074565b67ffffffffffffffff811115620002ff57620002fe6200007e565b5b6200030b8254620000d8565b6200031882828562000241565b5f60209050601f8311600181146200034e575f841562000339578287015190505b620003458582620002bb565b865550620003b4565b601f1984166200035e866200010c565b5f5b82811015620003875784890151825560018201915060208501945060208101905062000360565b86831015620003a75784890151620003a3601f8916826200029d565b8355505b6001600288020188555050505b505050505050565b611fdc80620003ca5f395ff3fe608060405234801561000f575f80fd5b5060043610610090575f3560e01c80634e1273f4116100645780634e1273f414610140578063731133e914610170578063a22cb4651461018c578063e985e9c5146101a8578063f242432a146101d857610090565b8062fdd58e1461009457806301ffc9a7146100c45780630e89341c146100f45780632eb2c2d614610124575b5f80fd5b6100ae60048036038101906100a991906113c9565b6101f4565b6040516100bb9190611416565b60405180910390f35b6100de60048036038101906100d99190611484565b610249565b6040516100eb91906114c9565b60405180910390f35b61010e600480360381019061010991906114e2565b61032a565b60405161011b9190611597565b60405180910390f35b61013e600480360381019061013991906117a7565b6103bc565b005b61015a60048036038101906101559190611932565b610463565b6040516101679190611a5f565b60405180910390f35b61018a60048036038101906101859190611a7f565b610570565b005b6101a660048036038101906101a19190611b29565b610582565b005b6101c260048036038101906101bd9190611b67565b610598565b6040516101cf91906114c9565b60405180910390f35b6101f260048036038101906101ed9190611ba5565b610626565b005b5f805f8381526020019081526020015f205f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2054905092915050565b5f7fd9b67a26000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916148061031357507f0e89341c000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916145b806103235750610322826106cd565b5b9050919050565b60606002805461033990611c65565b80601f016020809104026020016040519081016040528092919081815260200182805461036590611c65565b80156103b05780601f10610387576101008083540402835291602001916103b0565b820191905f5260205f20905b81548152906001019060200180831161039357829003601f168201915b50505050509050919050565b5f6103c5610736565b90508073ffffffffffffffffffffffffffffffffffffffff168673ffffffffffffffffffffffffffffffffffffffff161415801561040a57506104088682610598565b155b1561044e5780866040517fe237d922000000000000000000000000000000000000000000000000000000008152600401610445929190611ca4565b60405180910390fd5b61045b868686868661073d565b505050505050565b606081518351146104af57815183516040517f5b0599910000000000000000000000000000000000000000000000000000000081526004016104a6929190611ccb565b60405180910390fd5b5f835167ffffffffffffffff8111156104cb576104ca6115bb565b5b6040519080825280602002602001820160405280156104f95781602001602082028036833780820191505090505b5090505f5b84518110156105655761053561051d828761083190919063ffffffff16565b610530838761084490919063ffffffff16565b6101f4565b82828151811061054857610547611cf2565b5b6020026020010181815250508061055e90611d4c565b90506104fe565b508091505092915050565b61057c84848484610857565b50505050565b61059461058d610736565b83836108ec565b5050565b5f60015f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f9054906101000a900460ff16905092915050565b5f61062f610736565b90508073ffffffffffffffffffffffffffffffffffffffff168673ffffffffffffffffffffffffffffffffffffffff161415801561067457506106728682610598565b155b156106b85780866040517fe237d9220000000000000000000000000000000000000000000000000000000081526004016106af929190611ca4565b60405180910390fd5b6106c58686868686610a55565b505050505050565b5f7f01ffc9a7000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916149050919050565b5f33905090565b5f73ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff16036107ad575f6040517f57f447ce0000000000000000000000000000000000000000000000000000000081526004016107a49190611d93565b60405180910390fd5b5f73ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff160361081d575f6040517f01a835140000000000000000000000000000000000000000000000000000000081526004016108149190611d93565b60405180910390fd5b61082a8585858585610b5b565b5050505050565b5f60208202602084010151905092915050565b5f60208202602084010151905092915050565b5f73ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff16036108c7575f6040517f57f447ce0000000000000000000000000000000000000000000000000000000081526004016108be9190611d93565b60405180910390fd5b5f806108d38585610c07565b915091506108e45f87848487610b5b565b505050505050565b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361095c575f6040517fced3e1000000000000000000000000000000000000000000000000000000000081526004016109539190611d93565b60405180910390fd5b8060015f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f6101000a81548160ff0219169083151502179055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c3183604051610a4891906114c9565b60405180910390a3505050565b5f73ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff1603610ac5575f6040517f57f447ce000000000000000000000000000000000000000000000000000000008152600401610abc9190611d93565b60405180910390fd5b5f73ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff1603610b35575f6040517f01a83514000000000000000000000000000000000000000000000000000000008152600401610b2c9190611d93565b60405180910390fd5b5f80610b418585610c07565b91509150610b528787848487610b5b565b50505050505050565b610b6785858585610c37565b5f73ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff1614610c00575f610ba3610736565b90506001845103610bef575f610bc25f8661084490919063ffffffff16565b90505f610bd85f8661084490919063ffffffff16565b9050610be8838989858589610fcd565b5050610bfe565b610bfd81878787878761117c565b5b505b5050505050565b60608060405191506001825283602083015260408201905060018152826020820152604081016040529250929050565b8051825114610c8157815181516040517f5b059991000000000000000000000000000000000000000000000000000000008152600401610c78929190611ccb565b60405180910390fd5b5f610c8a610736565b90505f5b8351811015610e8c575f610cab828661084490919063ffffffff16565b90505f610cc1838661084490919063ffffffff16565b90505f73ffffffffffffffffffffffffffffffffffffffff168873ffffffffffffffffffffffffffffffffffffffff1614610de4575f805f8481526020019081526020015f205f8a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2054905081811015610d9057888183856040517f03dee4c5000000000000000000000000000000000000000000000000000000008152600401610d879493929190611dac565b60405180910390fd5b8181035f808581526020019081526020015f205f8b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2081905550505b5f73ffffffffffffffffffffffffffffffffffffffff168773ffffffffffffffffffffffffffffffffffffffff1614610e7957805f808481526020019081526020015f205f8973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f828254610e719190611def565b925050819055505b505080610e8590611d4c565b9050610c8e565b506001835103610f47575f610eaa5f8561084490919063ffffffff16565b90505f610ec05f8561084490919063ffffffff16565b90508573ffffffffffffffffffffffffffffffffffffffff168773ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f628585604051610f38929190611ccb565b60405180910390a45050610fc6565b8373ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff167f4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb8686604051610fbd929190611e22565b60405180910390a45b5050505050565b5f8473ffffffffffffffffffffffffffffffffffffffff163b1115611174578373ffffffffffffffffffffffffffffffffffffffff1663f23a6e6187878686866040518663ffffffff1660e01b815260040161102d959493929190611ea9565b6020604051808303815f875af192505050801561106857506040513d601f19601f820116820180604052508101906110659190611f15565b60015b6110e9573d805f8114611096576040519150601f19603f3d011682016040523d82523d5f602084013e61109b565b606091505b505f8151036110e157846040517f57f447ce0000000000000000000000000000000000000000000000000000000081526004016110d89190611d93565b60405180910390fd5b805181602001fd5b63f23a6e6160e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916817bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19161461117257846040517f57f447ce0000000000000000000000000000000000000000000000000000000081526004016111699190611d93565b60405180910390fd5b505b505050505050565b5f8473ffffffffffffffffffffffffffffffffffffffff163b1115611323578373ffffffffffffffffffffffffffffffffffffffff1663bc197c8187878686866040518663ffffffff1660e01b81526004016111dc959493929190611f40565b6020604051808303815f875af192505050801561121757506040513d601f19601f820116820180604052508101906112149190611f15565b60015b611298573d805f8114611245576040519150601f19603f3d011682016040523d82523d5f602084013e61124a565b606091505b505f81510361129057846040517f57f447ce0000000000000000000000000000000000000000000000000000000081526004016112879190611d93565b60405180910390fd5b805181602001fd5b63bc197c8160e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916817bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19161461132157846040517f57f447ce0000000000000000000000000000000000000000000000000000000081526004016113189190611d93565b60405180910390fd5b505b505050505050565b5f604051905090565b5f80fd5b5f80fd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6113658261133c565b9050919050565b6113758161135b565b811461137f575f80fd5b50565b5f813590506113908161136c565b92915050565b5f819050919050565b6113a881611396565b81146113b2575f80fd5b50565b5f813590506113c38161139f565b92915050565b5f80604083850312156113df576113de611334565b5b5f6113ec85828601611382565b92505060206113fd858286016113b5565b9150509250929050565b61141081611396565b82525050565b5f6020820190506114295f830184611407565b92915050565b5f7fffffffff0000000000000000000000000000000000000000000000000000000082169050919050565b6114638161142f565b811461146d575f80fd5b50565b5f8135905061147e8161145a565b92915050565b5f6020828403121561149957611498611334565b5b5f6114a684828501611470565b91505092915050565b5f8115159050919050565b6114c3816114af565b82525050565b5f6020820190506114dc5f8301846114ba565b92915050565b5f602082840312156114f7576114f6611334565b5b5f611504848285016113b5565b91505092915050565b5f81519050919050565b5f82825260208201905092915050565b5f5b83811015611544578082015181840152602081019050611529565b5f8484015250505050565b5f601f19601f8301169050919050565b5f6115698261150d565b6115738185611517565b9350611583818560208601611527565b61158c8161154f565b840191505092915050565b5f6020820190508181035f8301526115af818461155f565b905092915050565b5f80fd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b6115f18261154f565b810181811067ffffffffffffffff821117156116105761160f6115bb565b5b80604052505050565b5f61162261132b565b905061162e82826115e8565b919050565b5f67ffffffffffffffff82111561164d5761164c6115bb565b5b602082029050602081019050919050565b5f80fd5b5f61167461166f84611633565b611619565b905080838252602082019050602084028301858111156116975761169661165e565b5b835b818110156116c057806116ac88826113b5565b845260208401935050602081019050611699565b5050509392505050565b5f82601f8301126116de576116dd6115b7565b5b81356116ee848260208601611662565b91505092915050565b5f80fd5b5f67ffffffffffffffff821115611715576117146115bb565b5b61171e8261154f565b9050602081019050919050565b828183375f83830152505050565b5f61174b611746846116fb565b611619565b905082815260208101848484011115611767576117666116f7565b5b61177284828561172b565b509392505050565b5f82601f83011261178e5761178d6115b7565b5b813561179e848260208601611739565b91505092915050565b5f805f805f60a086880312156117c0576117bf611334565b5b5f6117cd88828901611382565b95505060206117de88828901611382565b945050604086013567ffffffffffffffff8111156117ff576117fe611338565b5b61180b888289016116ca565b935050606086013567ffffffffffffffff81111561182c5761182b611338565b5b611838888289016116ca565b925050608086013567ffffffffffffffff81111561185957611858611338565b5b6118658882890161177a565b9150509295509295909350565b5f67ffffffffffffffff82111561188c5761188b6115bb565b5b602082029050602081019050919050565b5f6118af6118aa84611872565b611619565b905080838252602082019050602084028301858111156118d2576118d161165e565b5b835b818110156118fb57806118e78882611382565b8452602084019350506020810190506118d4565b5050509392505050565b5f82601f830112611919576119186115b7565b5b813561192984826020860161189d565b91505092915050565b5f806040838503121561194857611947611334565b5b5f83013567ffffffffffffffff81111561196557611964611338565b5b61197185828601611905565b925050602083013567ffffffffffffffff81111561199257611991611338565b5b61199e858286016116ca565b9150509250929050565b5f81519050919050565b5f82825260208201905092915050565b5f819050602082019050919050565b6119da81611396565b82525050565b5f6119eb83836119d1565b60208301905092915050565b5f602082019050919050565b5f611a0d826119a8565b611a1781856119b2565b9350611a22836119c2565b805f5b83811015611a52578151611a3988826119e0565b9750611a44836119f7565b925050600181019050611a25565b5085935050505092915050565b5f6020820190508181035f830152611a778184611a03565b905092915050565b5f805f8060808587031215611a9757611a96611334565b5b5f611aa487828801611382565b9450506020611ab5878288016113b5565b9350506040611ac6878288016113b5565b925050606085013567ffffffffffffffff811115611ae757611ae6611338565b5b611af38782880161177a565b91505092959194509250565b611b08816114af565b8114611b12575f80fd5b50565b5f81359050611b2381611aff565b92915050565b5f8060408385031215611b3f57611b3e611334565b5b5f611b4c85828601611382565b9250506020611b5d85828601611b15565b9150509250929050565b5f8060408385031215611b7d57611b7c611334565b5b5f611b8a85828601611382565b9250506020611b9b85828601611382565b9150509250929050565b5f805f805f60a08688031215611bbe57611bbd611334565b5b5f611bcb88828901611382565b9550506020611bdc88828901611382565b9450506040611bed888289016113b5565b9350506060611bfe888289016113b5565b925050608086013567ffffffffffffffff811115611c1f57611c1e611338565b5b611c2b8882890161177a565b9150509295509295909350565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f6002820490506001821680611c7c57607f821691505b602082108103611c8f57611c8e611c38565b5b50919050565b611c9e8161135b565b82525050565b5f604082019050611cb75f830185611c95565b611cc46020830184611c95565b9392505050565b5f604082019050611cde5f830185611407565b611ceb6020830184611407565b9392505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f611d5682611396565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203611d8857611d87611d1f565b5b600182019050919050565b5f602082019050611da65f830184611c95565b92915050565b5f608082019050611dbf5f830187611c95565b611dcc6020830186611407565b611dd96040830185611407565b611de66060830184611407565b95945050505050565b5f611df982611396565b9150611e0483611396565b9250828201905080821115611e1c57611e1b611d1f565b5b92915050565b5f6040820190508181035f830152611e3a8185611a03565b90508181036020830152611e4e8184611a03565b90509392505050565b5f81519050919050565b5f82825260208201905092915050565b5f611e7b82611e57565b611e858185611e61565b9350611e95818560208601611527565b611e9e8161154f565b840191505092915050565b5f60a082019050611ebc5f830188611c95565b611ec96020830187611c95565b611ed66040830186611407565b611ee36060830185611407565b8181036080830152611ef58184611e71565b90509695505050505050565b5f81519050611f0f8161145a565b92915050565b5f60208284031215611f2a57611f29611334565b5b5f611f3784828501611f01565b91505092915050565b5f60a082019050611f535f830188611c95565b611f606020830187611c95565b8181036040830152611f728186611a03565b90508181036060830152611f868185611a03565b90508181036080830152611f9a8184611e71565b9050969550505050505056fea26469706673582212207b4b1e01146a06ec95903dc2902fdf1dd617a5f3275ba3ccc86856efadaf3d0964736f6c63430008140033';

export const deploy1155 = async (req: Request, res: Response) => {
  try {
    const provider = getProvider();
    const contract = new provider.eth.Contract(erc_1155_abi as AbiItem[]);
    const account = (await provider.eth.getAccounts())[0];
    await contract
      .deploy({ data: testErc1155Bytecode })
      .send({ from: account, gas: 5_000_000 })
      .on('receipt', function (receipt) {
        res
          .status(200)
          .json({ contractAddress: receipt.contractAddress })
          .send();
      });
  } catch (err) {
    console.error(err);
    res
      .status(500)
      .json({
        message: 'Internal server error',
        error: String(err),
      })
      .send();
  }
};

export const mint1155 = async (req: Request, res: Response) => {
  try {
    const request: erc1155Mint = req.body;
    const provider = getProvider();
    const contract = erc_1155(request.contractAddress, provider);
    const accounts = await provider.eth.getAccounts();

    const tx = await contract.methods.mint(
      request.to,
      request.tokenId,
      request.amount,
      '',
    );
    const txReceipt = await tx.send({ from: accounts[0], gas: 500000 });

    res.status(200).json({ block: txReceipt['blockNumber'] }).send();
  } catch (err) {
    res
      .status(500)
      .json({
        message: 'Internal server error',
        error: String(err),
      })
      .send();
  }
};
