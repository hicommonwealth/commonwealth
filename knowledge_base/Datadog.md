# Datadog

We use Datadog for three things: for metrics, for alerts, and to ingest logs from [Heroku](./Heroku.md).

The Datadog dashboard can be located at <us5.datadoghq.com>. NB: We use the US5 region; attempts to login and access the dashboard from other regions will silently fail.

As of 240102, only the main dashboard can be trusted for accurate data reports. Many of the autogenerated dashboards report data differently, leading to inconsistency or errors.

## Metrics

In our codebase, we use the `StatsDController` (`common-common/src/statsd`) to increment counters and add tags.

For instance, every time `TokenBalanceCache` successfully fetches, we call `.increment` on the controller and then tag the count accordingly, allowing us to easily locate the relevant metrics from Datadog's dashboard, create charts/graphic visualizations.

## Alerts

Every Heroku dyno emits a service heartbeat to Datadog every X seconds (e.g. 30, 60) to say “I’m alive.” If the heartbeat isn’t received, Datadog emits an alert to our #eng-feed-datadog Slack channel.

## Ingesting & Remapping Heroku Logs

Because we host through Heroku, we cannot set up raw metrics the way we normally might in Datadog. Metrics set up using the Datadog dashboard, using the provided member usage or CPU usage statistics, will be inaccurate, since the metrics reported are from the underlying server instance, and not from the relevant dyno container.

To set up up dyno-scoped metrics on Datadog:

1. Enable Heroku Labs Dyno Metadata and Heroku Labs Log Runtime metrics. Heroku will log dyno metrics directly into our regular log feed.

2. Set up Datadog to parse these logs and extract the data we need from them. Datadog ingests logs from Heroku in raw format and passes them through a pipeline which parses and remaps the log metrics. (Heroku buildpack takes care of this pipeline for us.) To display these metrics on the main dashboard, we need to create a Datadog Measure. A Datadog Measure is a key-value pair consisting of a number and reference string. To create a new Measure from the dashboard, select the parsed value from the event attributes, navigate to “Create Measure,” name it, and click "Add."

For more complete Heroku documentation, see our dedicated [knowledge base entry](./Heroku.md).

### Postgres Metrics

To enable Postgres Metrics, the env var `DD_ENABLE_HEROKU_POSTGRES` must be set to `true`. 

For a list of available `postgresql` metrics, see <https://docs.datadoghq.com/integrations/postgres/?tab=host#metrics>. Because we host through Heroku, not all these metrics will be reported; the only way to know is to create a metric and find out.

For more information, see the [Datadtog Postgres Guide](
https://docs.datadoghq.com/database_monitoring/guide/heroku-postgres).

### Redis Metrics

To enable Postgres Metrics, the env var `DD_ENABLE_HEROKU_REDIS` must be set to `true`. This will automatically trigger Redis metrics ingestion.

### RabbitMQ Metrics

To set up the RabbitMQ metrics, navigate to "Resources" from the Heroku dashboard. Then pull up CloudAMQP, navigate to the "Integrations" tab listed in the sidebar. Navigate to "Logs & Metrics"; from the Metrics section, add DataDog v2 integration.

For a list of the metrics available on `rabbitmq`, see >https://docs.datadoghq.com/integrations/rabbitmq/?tab=host#metrics>. Because we host through Heroku, not all these metrics will be reported; the only way to know is to create a metric and find out.

For more complete RabbitMQ documentation, see our dedicated [knowledge base entry](./RabbitMQ.md).

## Environment Variables

Set the following environment variables:

```bash
  DD_AGENT_MAJOR_VERSION=7
  DD_API_KEY=<SECRET-DATADOG-ACCOUNT-KEY>
  DD_DYNO_HOST=true
  DD_LOG_LEVEL=WARN
  DD_SITE=us5.datadoghq.com
  DD_ENABLE_HEROKU_POSTGRES=true
  DD_ENABLE_HEROKU_REDIS=true
  DD_DISABLE_HOST_METRICS=true
```

## Change Log

- 240102: Rewritten by Graham Johnson with assistance of Timothee Legros.
- 231031: Split off by Graham Johnson from `commonwealth/README.md`. Flagged for overhaul.
