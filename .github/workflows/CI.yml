name: CI

env:
  APP_ENV: CI
  IS_CI: true
  CI: true # ensures Vitest allowOnly option is false so no tests are accidentally skipped
  NODE_ENV: 'test'
  ROLLBAR_ENV: 'GitHubCI'
  TEST_WITHOUT_LOGS: 'true'
  PRIVATE_KEY: '0x83c65f24efbc8f4bc54ad425e897fc3ea01f760d5e71671a30eacb075ebe2313'
  USES_DOCKER_PGSQL: true
  PORT: 8080
  REDIS_URL: redis://localhost:6379
  GITHUB_BASE_REF: ${{ github.base_ref }}
  FEDERATION_POSTGRES_DB_URL: postgresql://commonwealth:edgeware@localhost/common_test
  ALCHEMY_PRIVATE_APP_KEY: ${{ secrets.ALCHEMY_PRIVATE_APP_KEY }}
  ALCHEMY_PUBLIC_APP_KEY: ${{ secrets.ALCHEMY_PUBLIC_APP_KEY }}

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to test (optional)"
        required: false
        type: number
  pull_request:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Start timer
        run: echo "::set-output name=start::$(date +%s)"
        id: timer_start

      - name: Install Heroku CLI
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh

      - name: End timer and show duration
        run: |
          end=$(date +%s)
          duration=$((end - ${{ steps.timer_start.outputs.start }}))
          echo "Duration: ${duration} seconds"

      - name: Deploy to Heroku
        run: |
          chmod +x ./scripts/deploy-to-heroku.sh
          ./scripts/deploy-to-heroku.sh "${{ secrets.HEROKU_EMAIL }}" "${{ secrets.HEROKU_API_TOKEN }}" commonwealth-frick